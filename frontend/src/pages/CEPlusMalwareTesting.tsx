import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import apiClient from '../api/client'

interface Test {
  id: string
  name: string
  description: string
  type: string
}

interface Platform {
  id: string
  name: string
  tests: Test[]
}

interface Category {
  id: string
  name: string
  description: string
  platforms: Platform[]
}

interface CEPlusInfo {
  title: string
  description: string
  categories: Category[]
}

export default function CEPlusMalwareTesting() {
  const [info, setInfo] = useState<CEPlusInfo | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')
  const [downloading, setDownloading] = useState<string | null>(null)
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null)
  const navigate = useNavigate()

  useEffect(() => {
    fetchInfo()
  }, [])

  const fetchInfo = async () => {
    try {
      const response = await apiClient.get<CEPlusInfo>('/ce-plus/')
      setInfo(response.data)
      setLoading(false)
      // Auto-select first category
      if (response.data.categories.length > 0) {
        setSelectedCategory(response.data.categories[0].id)
      }
    } catch (err: any) {
      setError(err.response?.data?.detail || 'Failed to load CE Plus information')
      setLoading(false)
    }
  }

  const handleDownload = async (categoryId: string, platformId: string, testId: string) => {
    const downloadKey = `${categoryId}-${platformId}-${testId}`
    setDownloading(downloadKey)
    setError('')

    try {
      const response = await apiClient.get(`/ce-plus/download/${categoryId}/${platformId}/${testId}`, {
        responseType: 'blob',
      })

      // Create blob URL and trigger download
      const blob = new Blob([response.data])
      const url = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      
      // Extract filename from Content-Disposition header or use default
      const contentDisposition = response.headers['content-disposition']
      let filename = `CEPlus-${categoryId}-${platformId}-${testId}`
      if (contentDisposition) {
        const filenameMatch = contentDisposition.match(/filename="(.+)"/)
        if (filenameMatch) {
          filename = filenameMatch[1]
        }
      }
      
      link.setAttribute('download', filename)
      document.body.appendChild(link)
      link.click()
      link.remove()
      window.URL.revokeObjectURL(url)
    } catch (err: any) {
      setError(err.response?.data?.detail || `Failed to download ${testId} for ${platformId}`)
    } finally {
      setDownloading(null)
    }
  }

  const getPlatformIcon = (platformId: string) => {
    switch (platformId) {
      case 'windows': return 'ü™ü'
      case 'mac': return 'üçé'
      case 'ios': return 'üì±'
      case 'android': return 'ü§ñ'
      case 'all': return 'üåê'
      default: return 'üíª'
    }
  }

  const getTypeBadgeColor = (type: string) => {
    switch (type) {
      case 'executable': return 'bg-red-100 text-red-800'
      case 'container': return 'bg-orange-100 text-orange-800'
      case 'document': return 'bg-blue-100 text-blue-800'
      case 'text': return 'bg-gray-100 text-gray-800'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 p-8">
        <div className="max-w-7xl mx-auto">
          <div className="text-center">Loading...</div>
        </div>
      </div>
    )
  }

  if (error && !info) {
    return (
      <div className="min-h-screen bg-gray-50 p-8">
        <div className="max-w-7xl mx-auto">
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        </div>
      </div>
    )
  }

  const currentCategory = info?.categories.find(cat => cat.id === selectedCategory)

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <button
            onClick={() => navigate('/')}
            className="mb-4 text-blue-600 hover:text-blue-800 font-medium"
          >
            ‚Üê Back to Home
          </button>
          <h1 className="text-4xl font-bold mb-2">{info?.title}</h1>
          <p className="text-xl text-gray-600 mb-4">{info?.description}</p>
          
          {/* Warning Banner */}
          <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
            <p className="font-semibold">‚ö†Ô∏è Important Notice</p>
            <p className="text-sm mt-1">
              These test files are designed to be detected and blocked by antivirus software. 
              This is expected and normal behavior. All test files contain safe, inert patterns 
              (EICAR or similar) used to verify that your endpoint protection is working correctly. 
              These files align with UK Cyber Essentials Plus Test Specification v3.2 requirements.
            </p>
          </div>
        </div>

        {/* Error Display */}
        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            {error}
          </div>
        )}

        {/* Category Tabs */}
        <div className="mb-6 border-b border-gray-200">
          <nav className="flex space-x-8 overflow-x-auto">
            {info?.categories.map((category) => (
              <button
                key={category.id}
                onClick={() => setSelectedCategory(category.id)}
                className={`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${
                  selectedCategory === category.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                {category.name}
              </button>
            ))}
          </nav>
        </div>

        {/* Category Description */}
        {currentCategory && (
          <div className="mb-6">
            <p className="text-gray-700">{currentCategory.description}</p>
          </div>
        )}

        {/* Platform Cards */}
        {currentCategory && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {currentCategory.platforms.map((platform) => (
              <div key={platform.id} className="bg-white rounded-lg shadow-md p-6">
                <h2 className="text-2xl font-semibold mb-4 flex items-center">
                  <span className="text-2xl mr-2">{getPlatformIcon(platform.id)}</span>
                  <span>{platform.name}</span>
                </h2>
                
                {platform.tests.length === 0 ? (
                  <p className="text-gray-500 text-sm">No tests available for this platform</p>
                ) : (
                  <div className="space-y-3">
                    {platform.tests.map((test) => {
                      const downloadKey = `${currentCategory.id}-${platform.id}-${test.id}`
                      const isDownloading = downloading === downloadKey
                      
                      return (
                        <div
                          key={test.id}
                          className="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors"
                        >
                          <div className="flex items-start justify-between mb-2">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <h3 className="font-semibold text-lg">{test.name}</h3>
                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${getTypeBadgeColor(test.type)}`}>
                                  {test.type}
                                </span>
                              </div>
                              <p className="text-sm text-gray-600">{test.description}</p>
                            </div>
                          </div>
                          <button
                            onClick={() => handleDownload(currentCategory.id, platform.id, test.id)}
                            disabled={isDownloading}
                            className="w-full mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed font-medium text-sm"
                          >
                            {isDownloading ? 'Downloading...' : 'Download'}
                          </button>
                        </div>
                      )
                    })}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {/* Information Section */}
        <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 className="text-xl font-semibold mb-3">About UK Cyber Essentials Plus Testing</h3>
          <div className="space-y-3 text-sm text-gray-700">
            <div>
              <p className="font-semibold mb-1">Test File Categories:</p>
              <ul className="list-disc list-inside ml-2 space-y-1">
                <li><strong>EICAR Test Files:</strong> Standard test patterns recognized by all antivirus software</li>
                <li><strong>Executable Files:</strong> Native binaries and scripts executable by default (BAT, PS1, VBS, SH, APK)</li>
                <li><strong>Container Formats:</strong> Compressed files (ZIP, GZ) that may contain malicious content</li>
                <li><strong>Documents with Embedded Malware:</strong> Common document types (DOCX, XLSX, PDF) containing inert malware samples</li>
              </ul>
            </div>
            <div>
              <p className="font-semibold mb-1">What to expect:</p>
              <p>
                When you download these files, your antivirus software should immediately detect and 
                quarantine or delete them. This confirms that your endpoint protection is functioning correctly.
              </p>
            </div>
            <div>
              <p className="font-semibold mb-1">Safety:</p>
              <p>
                All test files are completely safe and contain no actual malware code. They use recognized 
                test patterns (EICAR) that are recognized by all major antivirus vendors as test files.
              </p>
            </div>
            <div>
              <p className="font-semibold mb-1">Compliance:</p>
              <p>
                This testing tool helps verify compliance with UK Cyber Essentials Plus requirements 
                for malware protection on endpoints, as specified in the CE Plus Test Specification v3.2.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
